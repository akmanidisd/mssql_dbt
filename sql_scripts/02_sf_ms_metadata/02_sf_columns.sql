-- JOINS the Snowflake & MSSQL COLUMNS metadate based on the COLUMN_KEY

create or replace TABLE MS_RAW.DBT_META.SF_COLUMNS (
    SCHEMA_ONLY_KEY VARCHAR(16777216),
    TABLE_ONLY_KEY VARCHAR(16777216),
    COLUMN_ONLY_KEY VARCHAR(16777216),
    TABLE_KEY VARCHAR(16777216),
    COLUMN_KEY VARCHAR(16777216),
    SF_TABLE_CATALOG VARCHAR(16777216),
    SF_TABLE_SCHEMA VARCHAR(16777216),
    SF_TABLE_NAME VARCHAR(16777216),
    SF_COLUMN_NAME VARCHAR(16777216),
    SF_ORDINAL_POSITION NUMBER(38,0),
    SF_COLUMN_DEFAULT VARCHAR(16777216),
    SF_IS_NULLABLE VARCHAR(3),
    SF_DATA_TYPE VARCHAR(16777216),
    SF_CHARACTER_MAXIMUM_LENGTH NUMBER(38,0),
    SF_CHARACTER_OCTET_LENGTH NUMBER(38,0),
    SF_NUMERIC_PRECISION NUMBER(38,0),
    SF_NUMERIC_PRECISION_RADIX NUMBER(2,0),
    SF_NUMERIC_SCALE NUMBER(38,0),
    SF_DATETIME_PRECISION NUMBER(38,0),
    SF_INTERVAL_TYPE VARCHAR(16777216),
    SF_INTERVAL_PRECISION NUMBER(38,0),
    SF_CHARACTER_SET_CATALOG VARCHAR(16777216),
    SF_CHARACTER_SET_SCHEMA VARCHAR(16777216),
    SF_CHARACTER_SET_NAME VARCHAR(16777216),
    SF_COLLATION_CATALOG VARCHAR(16777216),
    SF_COLLATION_SCHEMA VARCHAR(16777216),
    SF_COLLATION_NAME VARCHAR(16777216),
    SF_DOMAIN_CATALOG VARCHAR(16777216),
    SF_DOMAIN_SCHEMA VARCHAR(16777216),
    SF_DOMAIN_NAME VARCHAR(16777216),
    SF_UDT_CATALOG VARCHAR(16777216),
    SF_UDT_SCHEMA VARCHAR(16777216),
    SF_UDT_NAME VARCHAR(16777216),
    SF_SCOPE_CATALOG VARCHAR(16777216),
    SF_SCOPE_SCHEMA VARCHAR(16777216),
    SF_SCOPE_NAME VARCHAR(16777216),
    SF_MAXIMUM_CARDINALITY VARCHAR(16777216),
    SF_DTD_IDENTIFIER VARCHAR(16777216),
    SF_IS_SELF_REFERENCING VARCHAR(2),
    SF_IS_IDENTITY VARCHAR(3),
    SF_IDENTITY_GENERATION VARCHAR(16777216),
    SF_IDENTITY_START NUMBER(38,0),
    SF_IDENTITY_INCREMENT NUMBER(38,0),
    SF_IDENTITY_MAXIMUM VARCHAR(16777216),
    SF_IDENTITY_MINIMUM VARCHAR(16777216),
    SF_IDENTITY_CYCLE VARCHAR(16777216),
    SF_IDENTITY_ORDERED VARCHAR(16777216),
    SF_SCHEMA_EVOLUTION_RECORD VARCHAR(16777216),
    SF_COMMENT VARCHAR(16777216),
    MS_TABLE_CATALOG VARCHAR(4),
    MS_TABLE_SCHEMA VARCHAR(16777216),
    MS_TABLE_NAME VARCHAR(16777216),
    MS_COLUMN_NAME VARCHAR(16777216),
    MS_ORDINAL_POSITION NUMBER(19,0),
    MS_COLUMN_DEFAULT VARCHAR(16777216),
    MS_IS_NULLABLE VARCHAR(16777216),
    MS_DATA_TYPE VARCHAR(16777216),
    MS_CHARACTER_MAXIMUM_LENGTH NUMBER(19,0),
    MS_CHARACTER_OCTET_LENGTH NUMBER(19,0),
    MS_NUMERIC_PRECISION NUMBER(19,0),
    MS_NUMERIC_PRECISION_RADIX NUMBER(19,0),
    MS_NUMERIC_SCALE NUMBER(19,0),
    MS_DATETIME_PRECISION NUMBER(19,0),
    MS_CHARACTER_SET_CATALOG VARCHAR(16777216),
    MS_CHARACTER_SET_SCHEMA VARCHAR(16777216),
    MS_CHARACTER_SET_NAME VARCHAR(16777216),
    MS_COLLATION_CATALOG VARCHAR(16777216),
    MS_COLLATION_SCHEMA VARCHAR(16777216),
    MS_COLLATION_NAME VARCHAR(16777216),
    MS_DOMAIN_CATALOG VARCHAR(16777216),
    MS_DOMAIN_SCHEMA VARCHAR(16777216),
    MS_DOMAIN_NAME VARCHAR(16777216)
--    _DLT_LOAD_ID VARCHAR(16777216)
);
INSERT INTO MS_RAW.DBT_META.SF_COLUMNS
WITH 
sf_cte AS (
    SELECT 
        TABLE_SCHEMA                  AS SCHEMA_ONLY_KEY,
        REPLACE(TABLE_NAME,   '_','') AS TABLE_ONLY_KEY,
        REPLACE(COLUMN_NAME,  '_','') AS COLUMN_ONLY_KEY,
        SCHEMA_ONLY_KEY || '.' || TABLE_ONLY_KEY  AS TABLE_KEY,
        TABLE_KEY       || '.' || COLUMN_ONLY_KEY AS COLUMN_KEY,
        *,
    --    MS.* EXCLUDE (_DLT_LOAD_ID)
    FROM MS_RAW.INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_SCHEMA IN ('DBO'
                          ,'DUPLICATEJOBSERVICE'
                          ,'JOBIMPORT'
                          ,'JOBS'
                          ,'RECRUITERJOBSTEXTKERNEL')
    ORDER BY COLUMN_KEY
)
, ms_cte AS (
    SELECT 
        UPPER(REPLACE((TABLE_SCHEMA || '.' || TABLE_NAME || '.' || COLUMN_NAME),'_',''))
            AS COLUMN_KEY,
        * EXCLUDE (_DLT_LOAD_ID)
    FROM MS_RAW.MS_META.COLUMNS
)
SELECT 
    sf_cte.*,
    ms_cte.* EXCLUDE (COLUMN_KEY)
FROM sf_cte
LEFT JOIN ms_cte
  ON sf_cte.COLUMN_KEY = ms_cte.COLUMN_KEY
;